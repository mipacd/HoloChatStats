<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HoloChatStats site metrics and analytics">
    <meta name="keywords" content="HoloChatStats, analytics, page views, unique visitors, country visits">
    <title>{{ _("Site Metrics") }}</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ GA_ID }}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    
    <style>
        html, body {
           overflow-x: hidden;
        }
        .chart-container {
            margin-top: 10px;
            position: relative;
            height: 40vh;
            max-width: 98vw;
            overflow-x: auto;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        body {
            background-color: #121212;
            color: white;
        }
        .form-select, .form-control {
            background-color: #222;
            color: white;
            border-color: #444;
        }
        .form-select option {
            background-color: #222;
            color: white;
        }
    </style>
</head>
<body>

{% include 'menu.html' %}

<div id="content" class="mt-3">
    <h2 class="text-center mb-4">{{ _("Site Metrics") }}</h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="pageViewsChart"></canvas>
                <div id="pageViewsLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="uniqueVisitorsChart"></canvas>
                <div id="uniqueVisitorsLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="countryVisitsChart"></canvas>
                <div id="countryVisitsLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="cacheDataChart"></canvas>
                <div id="cacheDataLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Page Views Chart
    $('#pageViewsLoading').removeClass('d-none');
    fetch('/api/metrics/page_views')
        .then(response => response.json())
        .then(data => {
            const sortedPages = Object.entries(data).sort((a, b) => b[1] - a[1]);

            new Chart(document.getElementById("pageViewsChart"), {
                type: "bar",
                data: {
                    labels: sortedPages.map(([page]) => page),
                    datasets: [{
                        label: "Total Page Views (Last 30 Days)",
                        data: sortedPages.map(([_, count]) => count),
                        backgroundColor: "rgba(75, 192, 192, 0.6)"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: "white" } },
                        y: { ticks: { color: "white" } }
                    },
                    plugins: {
                        title: { display: true, text: "Total Page Views (Last 30 Days)", color: "white" },
                        legend: { labels: { color: "white" } }
                    }
                }
            });

            $('#pageViewsLoading').addClass('d-none');
        })
        .catch(error => {
            console.error("Error loading page views:", error);
            $('#pageViewsLoading').addClass('d-none');
        });


    // Unique Visitors Chart
    $('#uniqueVisitorsLoading').removeClass('d-none');
    fetch('/api/metrics/unique_visitors')
        .then(response => response.json())
        .then(data => {
            new Chart(document.getElementById("uniqueVisitorsChart"), {
                type: "line",
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: "Unique Visitors", 
                        data: Object.values(data), 
                        borderColor: "blue", 
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: "white" } },
                        y: { ticks: { color: "white" } }
                    },
                    plugins: {
                        title: { display: true, text: "Unique Visitors", color: "white" },
                        legend: { labels: { color: "white" } }
                    }
                }
            });
            $('#uniqueVisitorsLoading').addClass('d-none');
        })
        .catch(error => {
            console.error("Error loading unique visitors:", error);
            $('#uniqueVisitorsLoading').addClass('d-none');
        });

    // Country Visits Chart
    $('#countryVisitsLoading').removeClass('d-none');
    fetch('/api/metrics/country_visits')
        .then(response => response.json())
        .then(data => {
            const sortedCountries = Object.entries(data).sort((a, b) => b[1] - a[1]);

            new Chart(document.getElementById("countryVisitsChart"), {
                type: "bar",
                data: {
                    labels: sortedCountries.map(([country]) => country),
                    datasets: [{
                        label: "Unique Visitors by Country",
                        data: sortedCountries.map(([_, count]) => count),
                        backgroundColor: "rgba(255, 99, 132, 0.6)"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: "white" } },
                        y: { ticks: { color: "white" } }
                    },
                    plugins: {
                        title: { display: true, text: "Unique Visitors by Country (Last 30 Days)", color: "white" },
                        legend: { labels: { color: "white" } }
                    }
                }
            });

            $('#countryVisitsLoading').addClass('d-none');
        })
        .catch(error => {
            console.error("Error loading country visits:", error);
            $('#countryVisitsLoading').addClass('d-none');
        });

    // Cache Data Stacked Bar Chart
    $('#cacheDataLoading').removeClass('d-none');
    fetch('/api/metrics/cache_data')
        .then(response => response.json())
        .then(data => {
            const labels = Object.keys(data);
            const datasets = [
                {
                    label: "Cache Hits",
                    data: labels.map(label => data[label].cache_hits),
                    backgroundColor: "rgba(75, 192, 192, 0.6)"
                },
                {
                    label: "Cache Misses",
                    data: labels.map(label => data[label].cache_misses),
                    backgroundColor: "rgba(255, 99, 132, 0.6)"
                }
            ];

            new Chart(document.getElementById("cacheDataChart"), {
                type: "bar",
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: "white" } },
                        y: { stacked: true, ticks: { color: "white" } }
                    },
                    plugins: {
                        title: { display: true, text: "Cache Data (Hits vs Misses)", color: "white" },
                        legend: { labels: { color: "white" } }
                    }
                }
            });

            $('#cacheDataLoading').addClass('d-none');
        })
        .catch(error => {
            console.error("Error loading cache data:", error);
            $('#cacheDataLoading').addClass('d-none');
        });


});
</script>

</body>
</html>
