<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HoloChatStats site metrics and analytics">
    <meta name="keywords" content="HoloChatStats, analytics, page views, unique visitors, country visits">
    <title>{{ _("Site Metrics") }}</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    
    <style>
        html, body {
           overflow-x: hidden;
        }
        .chart-container {
            margin-top: 10px;
            position: relative;
            height: 40vh;
            max-width: 98vw;
            overflow-x: auto;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        body {
            background-color: #121212;
            color: white;
        }
        .form-select, .form-control {
            background-color: #222;
            color: white;
            border-color: #444;
        }
        .form-select option {
            background-color: #222;
            color: white;
        }
        
        /* World Map Styles */
        .map-container {
            margin-top: 10px;
            position: relative;
            height: 40vh;
            max-width: 98vw;
            background-color: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #worldMap {
            width: 100%;
            height: 100%;
        }
        
        #worldMap svg {
            width: 100%;
            height: 100%;
        }
        
        .country {
            stroke: #2d2d44;
            stroke-width: 0.5px;
            transition: opacity 0.2s;
        }
        
        .country:hover {
            opacity: 0.8;
            stroke: #fff;
            stroke-width: 1px;
        }
        
        .country-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid #444;
        }
        
        .country-tooltip .country-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .country-tooltip .visitor-count {
            color: #4ecdc4;
        }
        
        .map-title {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
        }
        
        .map-legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 10;
        }
        
        .legend-gradient {
            width: 150px;
            height: 12px;
            border-radius: 2px;
            margin-bottom: 6px;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            color: #aaa;
        }
        
        .legend-title {
            color: #ccc;
            font-size: 10px;
            margin-bottom: 4px;
            text-align: center;
        }
    </style>
</head>
<body>

{% include 'menu.html' %}

<div id="content" class="mt-3">
    <h2 class="text-center mb-4">{{ _("Live Site Metrics") }}</h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="pageViewsChart"></canvas>
                <div id="pageViewsLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="uniqueVisitorsChart"></canvas>
                <div id="uniqueVisitorsLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <!-- Replaced bar chart with world map -->
            <div class="map-container">
                <div class="map-title">{{ _("Unique Visitors by Country (Last 30 Days)") }}</div>
                <div id="worldMap"></div>
                <div class="map-legend">
                    <div class="legend-title">Visitors</div>
                    <div class="legend-gradient" id="legendGradient"></div>
                    <div class="legend-labels">
                        <span>0</span>
                        <span id="legendMid">-</span>
                        <span id="maxVisitors">-</span>
                    </div>
                </div>
                <div id="countryVisitsLoading" class="position-absolute top-50 start-50 translate-middle">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="cacheDataChart"></canvas>
                <div id="cacheDataLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const socket = io.connect(window.location.origin, {
        transports: ['websocket'],
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 2000,
        timeout: 5000
    });

    // ISO Alpha-2 to ISO Numeric code mapping (for TopoJSON world-atlas)
    const isoA2ToNum = {
        'AF': '004', 'AL': '008', 'DZ': '012', 'AS': '016', 'AD': '020',
        'AO': '024', 'AI': '660', 'AQ': '010', 'AG': '028', 'AR': '032',
        'AM': '051', 'AW': '533', 'AU': '036', 'AT': '040', 'AZ': '031',
        'BS': '044', 'BH': '048', 'BD': '050', 'BB': '052', 'BY': '112',
        'BE': '056', 'BZ': '084', 'BJ': '204', 'BM': '060', 'BT': '064',
        'BO': '068', 'BA': '070', 'BW': '072', 'BR': '076', 'BN': '096',
        'BG': '100', 'BF': '854', 'BI': '108', 'CV': '132', 'KH': '116',
        'CM': '120', 'CA': '124', 'KY': '136', 'CF': '140', 'TD': '148',
        'CL': '152', 'CN': '156', 'CO': '170', 'KM': '174', 'CG': '178',
        'CD': '180', 'CR': '188', 'CI': '384', 'HR': '191', 'CU': '192',
        'CY': '196', 'CZ': '203', 'DK': '208', 'DJ': '262', 'DM': '212',
        'DO': '214', 'EC': '218', 'EG': '818', 'SV': '222', 'GQ': '226',
        'ER': '232', 'EE': '233', 'SZ': '748', 'ET': '231', 'FJ': '242',
        'FI': '246', 'FR': '250', 'GF': '254', 'PF': '258', 'GA': '266',
        'GM': '270', 'GE': '268', 'DE': '276', 'GH': '288', 'GR': '300',
        'GL': '304', 'GD': '308', 'GP': '312', 'GU': '316', 'GT': '320',
        'GN': '324', 'GW': '624', 'GY': '328', 'HT': '332', 'HN': '340',
        'HK': '344', 'HU': '348', 'IS': '352', 'IN': '356', 'ID': '360',
        'IR': '364', 'IQ': '368', 'IE': '372', 'IL': '376', 'IT': '380',
        'JM': '388', 'JP': '392', 'JO': '400', 'KZ': '398', 'KE': '404',
        'KI': '296', 'KP': '408', 'KR': '410', 'KW': '414', 'KG': '417',
        'LA': '418', 'LV': '428', 'LB': '422', 'LS': '426', 'LR': '430',
        'LY': '434', 'LI': '438', 'LT': '440', 'LU': '442', 'MO': '446',
        'MG': '450', 'MW': '454', 'MY': '458', 'MV': '462', 'ML': '466',
        'MT': '470', 'MH': '584', 'MQ': '474', 'MR': '478', 'MU': '480',
        'MX': '484', 'FM': '583', 'MD': '498', 'MC': '492', 'MN': '496',
        'ME': '499', 'MA': '504', 'MZ': '508', 'MM': '104', 'NA': '516',
        'NR': '520', 'NP': '524', 'NL': '528', 'NC': '540', 'NZ': '554',
        'NI': '558', 'NE': '562', 'NG': '566', 'MK': '807', 'NO': '578',
        'OM': '512', 'PK': '586', 'PW': '585', 'PS': '275', 'PA': '591',
        'PG': '598', 'PY': '600', 'PE': '604', 'PH': '608', 'PL': '616',
        'PT': '620', 'PR': '630', 'QA': '634', 'RE': '638', 'RO': '642',
        'RU': '643', 'RW': '646', 'SA': '682', 'SN': '686', 'RS': '688',
        'SC': '690', 'SL': '694', 'SG': '702', 'SK': '703', 'SI': '705',
        'SB': '090', 'SO': '706', 'ZA': '710', 'SS': '728', 'ES': '724',
        'LK': '144', 'SD': '729', 'SR': '740', 'SE': '752', 'CH': '756',
        'SY': '760', 'TW': '158', 'TJ': '762', 'TZ': '834', 'TH': '764',
        'TL': '626', 'TG': '768', 'TO': '776', 'TT': '780', 'TN': '788',
        'TR': '792', 'TM': '795', 'UG': '800', 'UA': '804', 'AE': '784',
        'GB': '826', 'US': '840', 'UY': '858', 'UZ': '860', 'VU': '548',
        'VE': '862', 'VN': '704', 'YE': '887', 'ZM': '894', 'ZW': '716',
        'XK': '-99', 'TF': '260', 'EH': '732', 'NC': '540', 'FK': '238',
        'GG': '831', 'IM': '833', 'JE': '832', 'SX': '534', 'CW': '531',
        'BQ': '535', 'SS': '728'
    };
    
    // ISO Numeric to Country Name mapping
    const numericToName = {
        '004': 'Afghanistan', '008': 'Albania', '012': 'Algeria', '016': 'American Samoa',
        '020': 'Andorra', '024': 'Angola', '028': 'Antigua and Barbuda', '031': 'Azerbaijan',
        '032': 'Argentina', '036': 'Australia', '040': 'Austria', '044': 'Bahamas',
        '048': 'Bahrain', '050': 'Bangladesh', '051': 'Armenia', '052': 'Barbados',
        '056': 'Belgium', '060': 'Bermuda', '064': 'Bhutan', '068': 'Bolivia',
        '070': 'Bosnia and Herzegovina', '072': 'Botswana', '076': 'Brazil', '084': 'Belize',
        '086': 'British Indian Ocean Territory', '090': 'Solomon Islands', '096': 'Brunei',
        '100': 'Bulgaria', '104': 'Myanmar', '108': 'Burundi', '112': 'Belarus',
        '116': 'Cambodia', '120': 'Cameroon', '124': 'Canada', '132': 'Cape Verde',
        '136': 'Cayman Islands', '140': 'Central African Republic', '144': 'Sri Lanka',
        '148': 'Chad', '152': 'Chile', '156': 'China', '158': 'Taiwan',
        '170': 'Colombia', '174': 'Comoros', '175': 'Mayotte', '178': 'Congo',
        '180': 'DR Congo', '188': 'Costa Rica', '191': 'Croatia', '192': 'Cuba',
        '196': 'Cyprus', '203': 'Czech Republic', '204': 'Benin', '208': 'Denmark',
        '212': 'Dominica', '214': 'Dominican Republic', '218': 'Ecuador', '222': 'El Salvador',
        '226': 'Equatorial Guinea', '231': 'Ethiopia', '232': 'Eritrea', '233': 'Estonia',
        '238': 'Falkland Islands', '242': 'Fiji', '246': 'Finland', '250': 'France',
        '254': 'French Guiana', '258': 'French Polynesia', '260': 'French Southern Territories',
        '262': 'Djibouti', '266': 'Gabon', '268': 'Georgia', '270': 'Gambia',
        '275': 'Palestine', '276': 'Germany', '288': 'Ghana', '296': 'Kiribati',
        '300': 'Greece', '304': 'Greenland', '308': 'Grenada', '312': 'Guadeloupe',
        '316': 'Guam', '320': 'Guatemala', '324': 'Guinea', '328': 'Guyana',
        '332': 'Haiti', '340': 'Honduras', '344': 'Hong Kong', '348': 'Hungary',
        '352': 'Iceland', '356': 'India', '360': 'Indonesia', '364': 'Iran',
        '368': 'Iraq', '372': 'Ireland', '376': 'Israel', '380': 'Italy',
        '384': 'Ivory Coast', '388': 'Jamaica', '392': 'Japan', '398': 'Kazakhstan',
        '400': 'Jordan', '404': 'Kenya', '408': 'North Korea', '410': 'South Korea',
        '414': 'Kuwait', '417': 'Kyrgyzstan', '418': 'Laos', '422': 'Lebanon',
        '426': 'Lesotho', '428': 'Latvia', '430': 'Liberia', '434': 'Libya',
        '438': 'Liechtenstein', '440': 'Lithuania', '442': 'Luxembourg', '446': 'Macao',
        '450': 'Madagascar', '454': 'Malawi', '458': 'Malaysia', '462': 'Maldives',
        '466': 'Mali', '470': 'Malta', '474': 'Martinique', '478': 'Mauritania',
        '480': 'Mauritius', '484': 'Mexico', '492': 'Monaco', '496': 'Mongolia',
        '498': 'Moldova', '499': 'Montenegro', '504': 'Morocco', '508': 'Mozambique',
        '512': 'Oman', '516': 'Namibia', '520': 'Nauru', '524': 'Nepal',
        '528': 'Netherlands', '531': 'Curaçao', '534': 'Sint Maarten', '535': 'Caribbean Netherlands',
        '540': 'New Caledonia', '548': 'Vanuatu', '554': 'New Zealand', '558': 'Nicaragua',
        '562': 'Niger', '566': 'Nigeria', '570': 'Niue', '574': 'Norfolk Island',
        '578': 'Norway', '580': 'Northern Mariana Islands', '581': 'US Minor Outlying Islands',
        '583': 'Micronesia', '584': 'Marshall Islands', '585': 'Palau', '586': 'Pakistan',
        '591': 'Panama', '598': 'Papua New Guinea', '600': 'Paraguay', '604': 'Peru',
        '608': 'Philippines', '612': 'Pitcairn Islands', '616': 'Poland', '620': 'Portugal',
        '624': 'Guinea-Bissau', '626': 'Timor-Leste', '630': 'Puerto Rico', '634': 'Qatar',
        '638': 'Réunion', '642': 'Romania', '643': 'Russia', '646': 'Rwanda',
        '652': 'Saint Barthélemy', '654': 'Saint Helena', '659': 'Saint Kitts and Nevis',
        '660': 'Anguilla', '662': 'Saint Lucia', '663': 'Saint Martin', '666': 'Saint Pierre and Miquelon',
        '670': 'Saint Vincent and the Grenadines', '674': 'San Marino', '678': 'São Tomé and Príncipe',
        '682': 'Saudi Arabia', '686': 'Senegal', '688': 'Serbia', '690': 'Seychelles',
        '694': 'Sierra Leone', '702': 'Singapore', '703': 'Slovakia', '704': 'Vietnam',
        '705': 'Slovenia', '706': 'Somalia', '710': 'South Africa', '716': 'Zimbabwe',
        '724': 'Spain', '728': 'South Sudan', '729': 'Sudan', '732': 'Western Sahara',
        '740': 'Suriname', '744': 'Svalbard and Jan Mayen', '748': 'Eswatini', '752': 'Sweden',
        '756': 'Switzerland', '760': 'Syria', '762': 'Tajikistan', '764': 'Thailand',
        '768': 'Togo', '772': 'Tokelau', '776': 'Tonga', '780': 'Trinidad and Tobago',
        '784': 'United Arab Emirates', '788': 'Tunisia', '792': 'Turkey', '795': 'Turkmenistan',
        '796': 'Turks and Caicos Islands', '798': 'Tuvalu', '800': 'Uganda', '804': 'Ukraine',
        '807': 'North Macedonia', '818': 'Egypt', '826': 'United Kingdom', '831': 'Guernsey',
        '832': 'Jersey', '833': 'Isle of Man', '834': 'Tanzania', '840': 'United States',
        '850': 'US Virgin Islands', '854': 'Burkina Faso', '858': 'Uruguay', '860': 'Uzbekistan',
        '862': 'Venezuela', '876': 'Wallis and Futuna', '882': 'Samoa', '887': 'Yemen',
        '894': 'Zambia', '-99': 'Kosovo'
    };
    
    // ISO Alpha-2 to Country Name mapping (for tooltip)
    const alpha2ToName = {};
    for (const [a2, num] of Object.entries(isoA2ToNum)) {
        if (numericToName[num]) {
            alpha2ToName[a2] = numericToName[num];
        }
    }

    // Page Views Chart
    let pageViewsChart = new Chart(document.getElementById("pageViewsChart"), {
        type: "bar",
        data: { labels: [], datasets: [{
            label: "Total Page Views (Last 30 Days)",
            data: [],
            backgroundColor: "rgba(75, 192, 192, 0.6)"
        }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { ticks: { color: "white", autoSkip: false } },
                y: { ticks: { color: "white" } }
            },
            plugins: {
                title: { display: true, text: "Total Page Views (Last 30 Days)", color: "white" },
                legend: { labels: { color: "white" } }
            }
        }
    });

    // Unique Visitors Chart
    let uniqueVisitorsChart = new Chart(document.getElementById("uniqueVisitorsChart"), {
        type: "line",
        data: { labels: [], datasets: [{
            label: "Unique Visitors",
            data: [],
            borderColor: "blue",
            fill: false
        }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { ticks: { color: "white" } },
                y: { ticks: { color: "white" } }
            },
            plugins: {
                title: { display: true, text: "Unique Visitors Over Time", color: "white" },
                legend: { labels: { color: "white" } }
            }
        }
    });

    // Cache Data Stacked Bar Chart
    let cacheDataChart = new Chart(document.getElementById("cacheDataChart"), {
        type: "bar",
        data: { labels: [], datasets: [
            { label: "Cache Hits", data: [], backgroundColor: "rgba(75, 192, 192, 0.6)" },
            { label: "Cache Misses", data: [], backgroundColor: "rgba(255, 99, 132, 0.6)" }
        ] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true, ticks: { color: "white" } },
                y: { stacked: true, ticks: { color: "white" } }
            },
            plugins: {
                title: { display: true, text: "Cache Data (Hits vs Misses)", color: "white" },
                legend: { labels: { color: "white" } }
            }
        }
    });

    // World Map Variables
    let worldMapSvg = null;
    let worldMapPath = null;
    let worldMapProjection = null;
    let worldMapCountries = null;
    let worldMapData = null;
    let worldMapGeoData = null;
    let countryVisitsData = {};
    let tooltip = null;
    
    // Color configuration
    const noVisitorsColor = "#2d3436";      // Dark gray for no visitors
    const minVisitorsColor = "#4a6fa5";     // Steel blue for low visitors
    const midVisitorsColor = "#e17055";     // Orange for medium visitors  
    const maxVisitorsColor = "#d63031";     // Bright red for high visitors

    // Get color for a country based on visitor count using logarithmic scale
    function getCountryColor(visitors, maxVisitors) {
        if (!visitors || visitors === 0) {
            return noVisitorsColor;
        }
        
        if (maxVisitors <= 1) {
            return minVisitorsColor;
        }
        
        // Use logarithmic scale for better distribution
        // This makes lower values more distinguishable
        const logMax = Math.log(maxVisitors);
        const logValue = Math.log(visitors);
        const t = logValue / logMax; // 0 to 1 on log scale
        
        // Use a multi-stop color interpolation for better visual distinction
        if (t < 0.5) {
            // Interpolate from minVisitorsColor to midVisitorsColor
            return d3.interpolateRgb(minVisitorsColor, midVisitorsColor)(t * 2);
        } else {
            // Interpolate from midVisitorsColor to maxVisitorsColor
            return d3.interpolateRgb(midVisitorsColor, maxVisitorsColor)((t - 0.5) * 2);
        }
    }
    
    // Update the legend gradient
    function updateLegendGradient(maxVisitors) {
        const gradient = `linear-gradient(to right, 
            ${noVisitorsColor} 0%, 
            ${minVisitorsColor} 1%, 
            ${midVisitorsColor} 50%, 
            ${maxVisitorsColor} 100%)`;
        document.getElementById('legendGradient').style.background = gradient;
        
        // Calculate and display midpoint value (using log scale)
        if (maxVisitors > 1) {
            const midValue = Math.round(Math.sqrt(maxVisitors));
            document.getElementById('legendMid').textContent = midValue.toLocaleString();
        } else {
            document.getElementById('legendMid').textContent = '-';
        }
    }

    // Initialize World Map
    async function initWorldMap() {
        const container = d3.select("#worldMap");
        const containerNode = container.node();
        const width = containerNode.clientWidth;
        const height = containerNode.clientHeight;
        
        // Create SVG
        worldMapSvg = container.append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");
        
        // Create tooltip
        tooltip = d3.select("body").append("div")
            .attr("class", "country-tooltip")
            .style("opacity", 0)
            .style("display", "none");
        
        // Load world map data
        try {
            worldMapData = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
            
            worldMapGeoData = topojson.feature(worldMapData, worldMapData.objects.countries);
            
            // Create projection using fitExtent to ensure full map is visible with padding
            const padding = 20;
            worldMapProjection = d3.geoNaturalEarth1()
                .fitExtent(
                    [[padding, padding], [width - padding, height - padding]], 
                    worldMapGeoData
                );
            
            worldMapPath = d3.geoPath().projection(worldMapProjection);
            
            worldMapCountries = worldMapSvg.selectAll("path")
                .data(worldMapGeoData.features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("d", worldMapPath)
                .attr("fill", noVisitorsColor)
                .on("mouseover", handleMouseOver)
                .on("mousemove", handleMouseMove)
                .on("mouseout", handleMouseOut);
            
            // Hide loading spinner
            $("#countryVisitsLoading").addClass("d-none");
            
        } catch (error) {
            console.error("Error loading world map:", error);
            $("#countryVisitsLoading").html('<span class="text-danger">Error loading map</span>');
        }
    }
    
    // Get country code from TopoJSON feature
    function getCountryCode(feature) {
        // TopoJSON world-atlas uses numeric ISO codes as id
        const numericId = String(feature.id).padStart(3, '0');
        // Find alpha-2 code from numeric
        for (const [a2, num] of Object.entries(isoA2ToNum)) {
            if (num === numericId) {
                return a2;
            }
        }
        return null;
    }
    
    // Get country name from feature
    function getCountryName(feature) {
        const numericId = String(feature.id).padStart(3, '0');
        return numericToName[numericId] || 'Unknown';
    }
    
    // Update map colors based on visitor data
    function updateWorldMap(countryData) {
        if (!worldMapCountries) return;
        
        countryVisitsData = countryData;
        
        // Find max visitors for color scale
        const values = Object.values(countryData);
        const maxVisitors = values.length > 0 ? Math.max(...values) : 1;
        
        // Update legend
        $("#maxVisitors").text(maxVisitors.toLocaleString());
        updateLegendGradient(maxVisitors);
        
        // Update country colors
        worldMapCountries.transition()
            .duration(500)
            .attr("fill", function(d) {
                const countryCode = getCountryCode(d);
                const visitors = countryCode ? (countryData[countryCode] || 0) : 0;
                return getCountryColor(visitors, maxVisitors);
            });
    }
    
    // Mouse event handlers
    function handleMouseOver(event, d) {
        const countryCode = getCountryCode(d);
        const countryName = getCountryName(d);
        const visitors = countryVisitsData[countryCode] || 0;
        
        tooltip
            .style("display", "block")
            .transition()
            .duration(200)
            .style("opacity", 1);
        
        tooltip.html(`
            <div class="country-name">${countryName} (${countryCode || '??'})</div>
            <div class="visitor-count">${visitors.toLocaleString()} visitor${visitors !== 1 ? 's' : ''}</div>
        `);
    }
    
    function handleMouseMove(event) {
        tooltip
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 10) + "px");
    }
    
    function handleMouseOut() {
        tooltip
            .transition()
            .duration(200)
            .style("opacity", 0)
            .on("end", function() {
                d3.select(this).style("display", "none");
            });
    }
    
    // Handle window resize
    function handleResize() {
        if (!worldMapSvg || !worldMapGeoData) return;
        
        const container = d3.select("#worldMap").node();
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        const padding = 20;
        worldMapProjection = d3.geoNaturalEarth1()
            .fitExtent(
                [[padding, padding], [width - padding, height - padding]], 
                worldMapGeoData
            );
        
        worldMapPath = d3.geoPath().projection(worldMapProjection);
        
        worldMapSvg.attr("viewBox", `0 0 ${width} ${height}`);
        
        if (worldMapCountries) {
            worldMapCountries.attr("d", worldMapPath);
        }
    }
    
    // Debounce resize handler
    let resizeTimeout;
    $(window).on("resize", function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(handleResize, 250);
    });

    // Update Function for charts
    function updateChart(chart, labels, data) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;

        // Flash effect on update
        chart.canvas.classList.add("chart-update-flash");
        setTimeout(() => chart.canvas.classList.remove("chart-update-flash"), 300);

        chart.update();
    }

    // WebSocket Listener
    socket.on("metrics_update", (data) => {
        const parsedData = JSON.parse(data);

        // Unique visitors ordered oldest to newest
        const sortedVisitors = Object.entries(parsedData.unique_visitors).sort((a, b) => new Date(a[0]) - new Date(b[0]));
        updateChart(uniqueVisitorsChart, sortedVisitors.map(([date]) => date), sortedVisitors.map(([_, count]) => count));

        // Update Page Views Chart
        const sortedPages = Object.entries(parsedData.page_views).sort((a, b) => b[1] - a[1]);
        updateChart(pageViewsChart, sortedPages.map(([page]) => page), sortedPages.map(([_, count]) => count));

        // Update World Map with country visits data (all countries, not limited)
        updateWorldMap(parsedData.country_visits);

        // Update Cache Data Chart
        const sortedCacheData = Object.entries(parsedData.cache_data).sort((a, b) => new Date(a[0]) - new Date(b[0]));

        const labels = sortedCacheData.map(([date]) => date);
        const cacheHits = sortedCacheData.map(([_, values]) => parseInt(values.cache_hits || 0));
        const cacheMisses = sortedCacheData.map(([_, values]) => parseInt(values.cache_misses || 0));

        cacheDataChart.data.labels = labels;
        cacheDataChart.data.datasets[0].data = cacheHits;
        cacheDataChart.data.datasets[1].data = cacheMisses;

        cacheDataChart.update();

        // Loading Spinner
        $("#pageViewsLoading").addClass("d-none");
    });

    // Initialize the world map
    initWorldMap();

    // Request Initial Data
    socket.emit("request_update");
});

</script>

</body>
</html>