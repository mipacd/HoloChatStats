<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="VTuber statistics chatbot.">
    <meta name="keywords" content="HoloChatStats, Hololive, VTuber, Indie, chat statistics, chatbot, virtual assistant, LLM, Eri">
    <title>{{ _("Eri Chat") }}</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

    <style>
        html,body { height: 100%; }
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background-image: url("/static/eri_neutral.png");
            background-size: contain;          
            background-repeat: no-repeat;
            background-position: center center; 
        }

        .chat-container {
            max-width: 1150px;
            margin: 36px auto;
            background-color: rgba(10,10,10,0.72);
            border-radius: 12px;
            padding: 18px;
            display: flex;
            flex-direction: column;
            height: 85vh;
            box-shadow: 0 6px 24px rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            padding-left: 6px;
            margin-bottom: 6px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Container for each message line (so bubbles can float left/right cleanly) */
        .message-row {
            display: flex;
            width: 100%;
        }

        /* assistant bubble (Eri) */
        .message-row.eri {
            justify-content: flex-start;
        }

        /* user bubble */
        .message-row.user {
            justify-content: flex-end;
        }

        .chat-bubble {
            display: inline-block;
            max-width: 78%;
            padding: 8px 12px;
            border-radius: 14px;
            line-height: 1.45;
            white-space: pre-line;
            word-break: break-word;
            box-shadow: 0 2px 6px rgba(0,0,0,0.35);
        }

        /* Eri's bubbles */
        .chat-bubble.eri {
            background-color: rgba(44,44,44,0.64);
            color: #e9eef6;
            border-bottom-left-radius: 6px;
            border-top-left-radius: 6px;
            border-top-right-radius: 14px;
        }

        /* User's bubbles */
        .chat-bubble.user {
            background-color: rgba(30,144,255,0.9);
            color: white;
            border-bottom-right-radius: 6px;
            border-top-right-radius: 6px;
            border-top-left-radius: 14px;
            text-align: left; /* text alignment inside bubble */
        }

        /* sender label */
        .chat-bubble .sender {
            display: block;
            font-weight: 500;
            color: #ffdede;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        /* markdown body text */
        .chat-bubble .msg {
            display: block;
            font-size: 0.95rem;
        }

        /* Markdown code blocks, inline code */
        .chat-bubble .msg pre {
            background: rgba(0,0,0,0.6);
            padding: 8px;
            border-radius: 6px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
            font-size: 0.88rem;
            color: #e0e0e0;
        }
        .chat-bubble .msg code {
            background: rgba(0,0,0,0.45);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
            font-size: 0.9rem;
        }


        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        .chat-input-wrapper {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .chat-input-wrapper input {
            width: 100%;
            border-radius: 8px;
            border: none;
            padding: 12px;
            padding-right: 90px; /* Space for buttons */
            background-color: rgba(25,25,25,0.6);
            color: white;
            outline: none;
        }

        .chat-input-wrapper input:disabled {
            background-color: rgba(25,25,25,0.4);
            color: #888;
            cursor: not-allowed;
        }
        .chat-input input {
            flex-grow: 1;
            border-radius: 8px;
            border: none;
            padding: 12px;
            background-color: rgba(25,25,25,0.6);
            color: white;
            outline: none;
        }
        .chat-input input:disabled {
            background-color: rgba(25,25,25,0.4);
            color: #888;
            cursor: not-allowed;
        }
        .chat-input button {
            border-radius: 8px;
            background-color: #1e90ff;
            color: white;
            border: none;
            padding: 10px 18px;
        }
        .chat-input button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        .chat-input button#sendBtn {
            border-radius: 8px;
            background-color: #1e90ff;
            color: white;
            border: none;
            padding: 10px 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-input button#sendBtn:hover {
            background-color: #0066cc;
        }

        .chat-input button#sendBtn:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        .input-inline-buttons {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .input-inline-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background-color: rgba(128, 128, 128, 0.6);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 14px;
        }

        .input-inline-btn:hover {
            background-color: rgba(128, 128, 128, 0.8);
        }

        .input-inline-btn:disabled {
            background-color: rgba(80, 80, 80, 0.4);
            color: #666;
            cursor: not-allowed;
        }

        .input-inline-btn.recording {
            background-color: #ef4444;
            animation: pulse-recording 1.5s ease-in-out infinite;
        }

        .input-inline-btn.recording:hover {
            background-color: #dc2626;
        }

        .input-inline-btn.speaking {
            background-color: #22c55e;
            animation: tts-pulse 1s ease-in-out infinite;
        }

        .input-inline-btn.speaking:hover {
            background-color: #16a34a;
        }

        .input-inline-btn.hidden {
            display: none;
        }

        .loading {
            text-align:center;
            color: #cfd8e3;
            font-style: italic;
            margin: 8px 0;
        }

        #adminBadge {
            color: #00ffbb;
            margin-right: 6px;
            cursor: help;
            user-select: none;
        }
        #adminBadge:hover {
            filter: drop-shadow(0 0 4px #00ffbb);
        }
        .chat-disclaimer {
            color: #a0a0a0; 
            font-size: 0.75rem; 
        }

        /* Prompts remaining counter */
        .prompts-remaining {
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 6px;
            background-color: rgba(255,255,255,0.1);
            white-space: nowrap;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        .prompts-remaining.level-good {
            color: #4ade80; /* Green */
        }
        .prompts-remaining.level-warning {
            color: #facc15; /* Yellow */
        }
        .prompts-remaining.level-danger {
            color: #f87171; /* Red */
        }
        .prompts-remaining.level-exhausted {
            color: #ef4444; /* Bright red */
            font-weight: 500;
        }

        /* Microphone button */
        .chat-input .mic-btn {
            border-radius: 8px;
            background-color: #1e90ff;
            color: white;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .chat-input .mic-btn:hover {
            background-color: #0066cc;
        }

        .chat-input .mic-btn:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        .chat-input .mic-btn.recording {
            background-color: #ef4444;
            animation: pulse-recording 1.5s ease-in-out infinite;
        }

        .chat-input .mic-btn.recording:hover {
            background-color: #dc2626;
        }

        /* TTS Button */
        .tts-btn {
            border-radius: 8px;
            background-color: #1e90ff;
            color: white;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .tts-btn:hover {
            background-color: #0066cc;
        }

        .tts-btn:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        .tts-btn.speaking {
            background-color: #22c55e;
            animation: tts-pulse 1s ease-in-out infinite;
        }

        .tts-btn.speaking:hover {
            background-color: #16a34a;
        }

        .tts-btn.hidden {
            display: none;
        }

        @keyframes tts-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Microphone button */
        .chat-input .mic-btn {
            border-radius: 8px;
            background-color: #1e90ff;
            color: white;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .chat-input .mic-btn:hover {
            background-color: #0066cc;
        }

        .chat-input .mic-btn:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        .chat-input .mic-btn.recording {
            background-color: #ef4444;
            animation: pulse-recording 1.5s ease-in-out infinite;
        }

        .chat-input .mic-btn.recording:hover {
            background-color: #dc2626;
        }

        /* Help Sidebar Styles */
.help-toggle {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #1e90ff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    z-index: 1000;
    transition: transform 0.2s, background-color 0.2s, opacity 0.3s, visibility 0.3s;
    opacity: 1;
    visibility: visible;
}

.help-toggle.hidden {
    opacity: 0;
    visibility: hidden;
    transform: scale(0.8);
}

.help-toggle:hover {
    transform: scale(1.1);
    background-color: #0066cc;
}

.help-toggle i {
    font-size: 24px;
}

.help-sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background-color: rgba(20, 20, 20, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: -4px 0 12px rgba(0,0,0,0.5);
    transition: right 0.3s ease-in-out;
    z-index: 999;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.help-sidebar.open {
    right: 0;
}

.help-header {
    padding: 20px;
    background-color: rgba(30, 30, 30, 0.9);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.help-header h5 {
    margin: 0;
    color: #ffffff;
    font-size: 1.2rem;
}

.close-help {
    background: none;
    border: none;
    color: #ffffff;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    transition: color 0.2s;
}

.close-help:hover {
    color: #1e90ff;
}

.help-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
}

.help-section {
    margin-bottom: 25px;
}

.section-header {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e90ff;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid rgba(30, 144, 255, 0.3);
}

.collapsible-item {
    margin-bottom: 10px;
    background-color: rgba(40, 40, 40, 0.5);
    border-radius: 8px;
    overflow: hidden;
}

.collapsible-header {
    width: 100%;
    padding: 12px 15px;
    background: none;
    border: none;
    color: #ffffff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s;
    font-size: 0.95rem;
    text-align: left;
}

.collapsible-header:hover {
    background-color: rgba(30, 144, 255, 0.1);
}

.collapsible-header i {
    transition: transform 0.3s;
    font-size: 12px;
}

.collapsible-header[aria-expanded="true"] i {
    transform: rotate(180deg);
}

.collapsible-content {
    height: 0;
    overflow: hidden;
    transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.collapsible-content-inner {
    padding: 0 15px 15px 15px;
}

.collapsible-content p {
    margin: 0;
    color: #d0d0d0;
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Responsive adjustments for sidebar */
@media (min-width: 1550px) {
    /* If there's enough space, position sidebar next to chat */
    .help-sidebar {
        right: -350px;
        width: 350px;
    }
    
    .help-sidebar.open {
        right: 20px;
    }
}

@media (max-width: 768px) {
    .help-toggle {
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
    }
    
    .help-sidebar {
        width: 100%;
        right: -100%;
    }
    
    .help-sidebar.open {
        right: 0;
    }
}

/* Custom scrollbar for help content */
.help-content::-webkit-scrollbar {
    width: 8px;
}

.help-content::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.help-content::-webkit-scrollbar-thumb {
    background: rgba(30, 144, 255, 0.5);
    border-radius: 4px;
}

.help-content::-webkit-scrollbar-thumb:hover {
    background: rgba(30, 144, 255, 0.7);
}

        @keyframes pulse-recording {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }
        }

.chat-input .mic-btn.hidden {
    display: none;
}

        @keyframes pulse-recording {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }

.chat-input .mic-btn.hidden {
    display: none;
}

        @media (max-width: 768px) {
            .chat-container { margin: 18px; height: 78vh; }
            .chat-bubble { max-width: 92%; }
            body { background-size: auto 55%; background-position: center top; }
        }
    </style>
</head>
<body>
{% include 'menu.html' %}

<div class="chat-container" aria-live="polite">
    <div id="chatMessages" class="chat-messages" role="log" aria-live="polite">
        <div class="chat-bubble eri">
            <span class="sender">{{ _("Eri") }}</span>
            <span class="msg">{{ _("Hey, I'm Eri - HoloChatStats' virtual assistant. How can I help you today?") }}</span>
        </div>
    </div>

    <div class="chat-input">
        <span id="adminBadge" title="Admin mode active" style="display:none; font-size:1.2rem;">üõ°Ô∏è</span>
        <div class="chat-input-wrapper">
            <input id="userInput" type="text" placeholder="{{ _("Ask Eri a question...") }}" aria-label="Message"/>
            <div class="input-inline-buttons">
                <button id="micBtn" class="input-inline-btn" aria-label="Voice input" title="{{ _("Voice input") }}">
                    <i class="bi bi-mic-fill"></i>
                </button>
                <button id="ttsBtn" class="input-inline-btn" aria-label="Read aloud" title="{{ _("Read aloud") }}">
                    <i class="bi bi-volume-up-fill"></i>
                </button>
            </div>
        </div>
        <button id="sendBtn" aria-label="Send"><i class="bi bi-send-fill"></i></button>
        <span id="promptsRemaining" class="prompts-remaining" style="display:none;" title="{{ _("Prompts remaining today") }}">
            <i class="bi bi-chat-dots"></i> <span id="promptCount">--</span>
        </span>
    </div>

    <div class="mt-2">
    <select id="promptDropdown" class="form-select bg-dark text-light border-secondary">
        <option value="">{{ _("üí° Try one of these prompts...") }}</option>
        <optgroup label="General Queries">
        <option>{{ _("Who streamed the most in Hololive last month?") }}</option>
        <option>{{ _("Which Hololive member had the highest average stream duration last month?") }}</option>
        <option>{{ _("Which Hololive member had the longest stream last month?") }}</option>
        <option>{{ _("Which Hololive member had the highest average Korean chat messages per minute last month?") }}</option>
        <option>{{ _("Which Hololive member had the most members last month?") }}</option>
        <option>{{ _("What are the top 3 Hololive members that gained the most memberships last month?") }}</option>
        <option>{{ _("Which Hololive member had the greatest increase in streaming hours last month?") }}</option>
        <option>{{ _("How can I support HoloChatStats?") }}</option>
        <option>{{ _("Hi Eri! How are you today? Who is your oshi?") }}</option>
        </optgroup>

        <optgroup label="Templated">
        <option>{{ _("Recommend some VTubers for me. My channel ID is: [YOUR_CHANNEL_ID_HERE]") }}</option>
        <option>{{ _("How many hours did [VTUBER_NAME] stream last month?") }}</option>
        <option>{{ _("How many chat users were common to [VTUBER_NAME] and [VTUBER_NAME] last month?") }}</option>
        <option>{{ _("How many membered chat users were common to [VTUBER_NAME] and [VTUBER_NAME] last month?") }}</option>
        <option>{{ _("Who are the most active chatters for [VTUBER_NAME] last month?") }}</option>
        <option>{{ _("What percentage of chat users chatted exclusively in [VTUBER_NAME]'s chat last month?") }}</option>
        <option>{{ _("What percentage of [VTUBER_NAME]'s chat was in Japanese last month?") }}</option>
        <option>{{ _("What percentage of [GRADUATED_FANBASE_NAME] still participate in Hololive chats?") }}</option>
        <option>{{ _("Give me some YouTube links to funny moments from [VTUBER_NAME]'s streams last month.") }}</option>
        <option>{{ _("Can you tell me which channels I chatted on last month? My channel ID is: [YOUR_CHANNEL_ID_HERE]") }}</option>
        <option>{{ _("Show me Hololive merch currently on sale for [VTUBER_NAME]") }}</option>
        <option>{{ _("How many subscribers does [VTUBER_NAME] have?") }}</option>
        <option>{{ _("What was [VTUBER_NAME]'s last stream?") }}</option>
        </optgroup>
    </select>
    </div>
    <div class="mt-3 text-center chat-disclaimer">
        <p class="mb-1">
            {{ _("Eri may display inaccurate information, so double-check its responses. Your conversations are logged to help make Eri better. By using Eri, you agree to this.") }}
        </p>
        <p class="mb-0">
            {{ _("Conversations in English may be more accurate than in other languages.") }}
        </p>
    </div>

</div>

<script>
let chatHistory = [];
let adminKey = null;
let dailyLimit = 10; // Will be updated from server
let isAdmin = false;
let recognition = null;
let isRecording = false;

// Text-to-speech variables
let synth = window.speechSynthesis;
let isSpeaking = false;
let ttsEnabled = false;
let lastEriMessage = {{ _("Hey, I'm Eri - HoloChatStats' virtual assistant. How can I help you today?") | tojson }};
let currentUtterance = null;

const urlParams = new URLSearchParams(window.location.search);
adminKey = urlParams.get("admin_key"); 

if (adminKey) {
    $('#adminBadge').show();
    isAdmin = true;
}

const baseUrl = window.location.hostname === 'localhost' ? 'http://127.0.0.1:8080' : 'https://llm.holochatstats.info';

const statusMessages = {
    'status_connecting': {{ _("Let's see...") | tojson }},
    'status_translating': {{ _("Deciphering your request...") | tojson }},
    'status_planner': {{ _("Alright, plotting a course of action.") | tojson }},
    'status_tools': {{ _("Searching the HoloChatStats archives...") | tojson }},
    'status_responder': {{ _("Compiling the data...") | tojson }},
    'rate_limit_exceeded': {{ _("Looks like you've reached the daily query limit. Please try again tomorrow.") | tojson }}
};

const limitReachedPlaceholder = {{ _("Daily prompt limit reached. Please try again tomorrow.") | tojson }};
const defaultPlaceholder = {{ _("Ask Eri a question...") | tojson }};

function updatePromptsRemainingDisplay(remaining) {
    const $counter = $('#promptsRemaining');
    const $count = $('#promptCount');
    
    $count.text(remaining);
    
    // Remove all level classes
    $counter.removeClass('level-good level-warning level-danger level-exhausted');
    
    // Calculate thresholds based on daily limit
    const warningThreshold = Math.ceil(dailyLimit * 0.5);  // 50%
    const dangerThreshold = Math.ceil(dailyLimit * 0.2);   // 20%
    
    if (remaining <= 0) {
        $counter.addClass('level-exhausted');
        disableChat();
    } else if (remaining <= dangerThreshold) {
        $counter.addClass('level-danger');
    } else if (remaining <= warningThreshold) {
        $counter.addClass('level-warning');
    } else {
        $counter.addClass('level-good');
    }
}

function disableChat() {
    $('#userInput')
        .prop('disabled', true)
        .val('')
        .attr('placeholder', limitReachedPlaceholder);
    $('#sendBtn').prop('disabled', true);
    $('#micBtn').prop('disabled', true);
    $('#ttsBtn').prop('disabled', true);
    $('#promptDropdown').prop('disabled', true);
    stopRecording();
    disableTTS();
}

function enableChat() {
    $('#userInput')
        .prop('disabled', false)
        .attr('placeholder', defaultPlaceholder);
    $('#sendBtn').prop('disabled', false);
    $('#micBtn').prop('disabled', false);
    $('#ttsBtn').prop('disabled', false);
    $('#promptDropdown').prop('disabled', false);
}

async function fetchPromptsRemaining() {
    // Don't show counter for admins
    if (isAdmin) {
        return;
    }
    
    try {
        const response = await fetch(`${baseUrl}/prompts-remaining`);
        if (response.ok) {
            const data = await response.json();
            dailyLimit = data.daily_limit;
            $('#promptsRemaining').show();
            updatePromptsRemainingDisplay(data.prompts_remaining);
        }
    } catch (err) {
        console.error('Failed to fetch prompts remaining:', err);
        // Still show the counter but with unknown state
        $('#promptsRemaining').show();
        $('#promptCount').text('--');
    }
}

function appendMessage(sender, text, isAssistantMarkdown = false) {
    const row = $('<div>').addClass('message-row').addClass(sender === 'eri' ? 'eri' : 'user');
    const bubble = $('<div>').addClass('chat-bubble').addClass(sender === 'eri' ? 'eri' : 'user');
    if (sender === 'eri') {
        bubble.append($('<span>').addClass('sender').text('Eri'));
        if (isAssistantMarkdown) {
            try {
                const rawHtml = marked.parse(text || '');
                const cleanHtml = DOMPurify.sanitize(rawHtml, { ALLOWED_ATTR: ['href', 'target', 'rel'] });
                bubble.append($('<span>').addClass('msg').html(cleanHtml));
            } catch { bubble.append($('<span>').addClass('msg').text(text)); }
        } else { bubble.append($('<span>').addClass('msg').text(text)); }
        
        // Store as last Eri message for TTS
        lastEriMessage = text;
        
        // If TTS is enabled, speak this message
        if (ttsEnabled) {
            speakText(text);
        }
    } else { bubble.append($('<span>').addClass('msg').text(text)); }
    row.append(bubble);
    $('#chatMessages').append(row);
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
}

async function sendMessage() {
    const message = $('#userInput').val().trim();
    if (!message) return;
    
    // Stop recording if active
    stopRecording();
    // Stop current speech (but keep TTS enabled for the response)
    stopSpeaking();
    
    appendMessage('user', message);
    $('#userInput').val('');
    chatHistory.push({"role": "user", "content": message});

    const loadingMsg = $('<div class="loading"></div>').text(statusMessages['status_connecting']);
    $('#chatMessages').append(loadingMsg);
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);

    try {
        const payload = { message, chat_history: chatHistory };
        if (adminKey) { payload.admin_key = adminKey; }

        const response = await fetch(`${baseUrl}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            if (response.status === 429) {
                try {
                    const errorData = await response.json();
                    // Get the error message from the detail object
                    const errorKey = errorData.detail?.key;
                    const errorMessage = statusMessages[errorKey] || errorData.detail?.message || statusMessages['rate_limit_exceeded'];
                    
                    // Remove the loading message and show the error as a proper message
                    loadingMsg.remove();
                    appendMessage('eri', errorMessage);
                    
                    // Update the counter to show 0 and disable chat
                    if (!isAdmin) {
                        updatePromptsRemainingDisplay(0);
                    }
                } catch (parseError) {
                    console.error("Failed to parse 429 error:", parseError);
                    // Fallback if JSON parsing fails for any reason
                    loadingMsg.remove();
                    appendMessage('eri', statusMessages['rate_limit_exceeded']);
                    if (!isAdmin) {
                        updatePromptsRemainingDisplay(0);
                    }
                }
            } else {
                const text = await response.text();
                console.error("LLM fetch failed:", response.status, text);
                loadingMsg.remove();
                appendMessage('eri', {{ _("Sorry ‚Äî I couldn't reach the assistant (network error).") | tojson }});
            }
            return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        const textDecoder = new TextDecoder();
        let sseBuffer = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            sseBuffer += textDecoder.decode(value, { stream: true });
            const events = sseBuffer.split("\n\n");
            sseBuffer = events.pop(); // Keep incomplete event

            for (const ev of events) {
                const line = ev.trim();
                if (!line.startsWith("data:")) continue;
                const jsonStr = line.slice(5).trim();

                try {
                    const update = JSON.parse(jsonStr);
                    if (update.type === "status") {
                        loadingMsg.text(statusMessages[update.key] || "Working...");
                    } else if (update.type === "answer") {
                        loadingMsg.remove();
                        appendMessage("eri", update.message, true);
                        chatHistory.push({ role: "assistant", content: update.message });
                        
                        // Refresh the prompts remaining counter after successful message
                        if (!isAdmin) {
                            fetchPromptsRemaining();
                        }
                    } else if (update.type === "error") {
                        loadingMsg.text(update.message);
                    }
                } catch (e) {
                    console.error("Invalid SSE data:", jsonStr, e);
                }
            }
        }

        // Flush last message after stream ends
        if (sseBuffer.trim().startsWith("data:")) {
            const jsonStr = sseBuffer.slice(5).trim();
            try {
                const update = JSON.parse(jsonStr);
                if (update.type === "answer") {
                    loadingMsg.remove();
                    appendMessage("eri", update.message, true);
                    chatHistory.push({ role: "assistant", content: update.message });
                    
                    // Refresh the prompts remaining counter after successful message
                    if (!isAdmin) {
                        fetchPromptsRemaining();
                    }
                }
            } catch (e) {
                console.error("Failed to parse final SSE event:", jsonStr, e);
            }
        }
        
        // Process any final data left in the buffer after the loop finishes
        if (buffer && buffer.startsWith('data: ')) {
            const dataString = buffer.substring(6);
            if (dataString) {
                try {
                    const update = JSON.parse(dataString);
                    if (update.type === 'answer') {
                        loadingMsg.remove();
                        appendMessage('eri', update.message, true);
                        chatHistory.push({"role": "assistant", "content": update.message});
                        
                        // Refresh the prompts remaining counter after successful message
                        if (!isAdmin) {
                            fetchPromptsRemaining();
                        }
                    }
                } catch (e) {
                    console.error('Failed to parse final stream chunk:', dataString, e);
                }
            }
        }

    } catch (err) {
        loadingMsg.remove();
        console.error(err);
        appendMessage('eri', "Sorry, something went wrong while contacting the assistant.");
    }
}

// Initialize speech recognition
function initSpeechRecognition() {
    // Check for Speech Recognition API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        // Firefox doesn't support Web Speech API for recognition
        // Check if we're in Firefox and show appropriate message
        const isFirefox = navigator.userAgent.toLowerCase().includes('firefox');
        if (isFirefox) {
            console.log('Speech recognition is not supported in Firefox. Please use Chrome, Edge, or Safari.');
        }
        $('#micBtn').addClass('hidden');
        return;
    }
    
    try {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = navigator.language || 'en-US';
        
        let finalTranscript = '';
        
        recognition.onstart = function() {
            isRecording = true;
            $('#micBtn').addClass('recording');
            $('#micBtn').attr('title', {{ _("Stop recording") | tojson }});
            finalTranscript = $('#userInput').val();
        };
        
        recognition.onresult = function(event) {
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }
            
            $('#userInput').val(finalTranscript + interimTranscript);
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            
            if (event.error === 'not-allowed') {
                alert({{ _("Microphone access was denied. Please allow microphone access to use voice input.") | tojson }});
            } else if (event.error === 'service-not-allowed' || event.error === 'not-allowed') {
                // This can happen in Firefox or when the API isn't available
                $('#micBtn').addClass('hidden');
            }
            
            stopRecording();
        };
        
        recognition.onend = function() {
            if (isRecording) {
                try {
                    recognition.start();
                } catch (e) {
                    stopRecording();
                }
            }
        };
    } catch (e) {
        console.error('Failed to initialize speech recognition:', e);
        $('#micBtn').addClass('hidden');
    }
}


function startRecording() {
    // Stop TTS if playing
    disableTTS();
    
    if (!recognition) {
        initSpeechRecognition();
        if (!recognition) return;
    }
    
    try {
        recognition.start();
    } catch (e) {
        console.error('Failed to start speech recognition:', e);
        try {
            recognition.stop();
            setTimeout(() => {
                try { recognition.start(); } catch (e2) { console.error('Failed to restart:', e2); }
            }, 100);
        } catch (e2) {}
    }
}


function stopRecording() {
    isRecording = false;
    $('#micBtn').removeClass('recording');
    $('#micBtn').attr('title', {{ _("Voice input") | tojson }});
    
    if (recognition) {
        try { recognition.stop(); } catch (e) {}
    }
}

function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

function initTTS() {
    if (!synth) {
        $('#ttsBtn').addClass('hidden');
        console.log('Text-to-speech not supported in this browser');
        return false;
    }
    return true;
}

function stripMarkdown(text) {
    return text
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/\*([^*]+)\*/g, '$1')
        .replace(/__([^_]+)__/g, '$1')
        .replace(/_([^_]+)_/g, '$1')
        .replace(/`{3}[\s\S]*?`{3}/g, '')
        .replace(/`([^`]+)`/g, '$1')
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/^#{1,6}\s+/gm, '')
        .replace(/^\s*[-*+]\s+/gm, '')
        .replace(/^\s*\d+\.\s+/gm, '')
        .replace(/^\s*>\s+/gm, '')
        .replace(/!\[([^\]]*)\]\([^)]+\)/g, '')
        .replace(/\n{2,}/g, '\n')
        .trim();
}

function getPreferredVoice() {
    const voices = synth.getVoices();
    const lang = navigator.language || 'en-US';
    
    const femaleKeywords = ['female', 'woman', 'girl', 'zira', 'samantha', 'victoria', 'karen', 'moira', 'tessa', 'fiona'];
    
    for (const voice of voices) {
        if (voice.lang.startsWith(lang.split('-')[0])) {
            const nameLower = voice.name.toLowerCase();
            if (femaleKeywords.some(kw => nameLower.includes(kw))) {
                return voice;
            }
        }
    }
    
    for (const voice of voices) {
        if (voice.lang.startsWith(lang.split('-')[0])) {
            return voice;
        }
    }
    
    for (const voice of voices) {
        if (voice.lang.startsWith('en')) {
            const nameLower = voice.name.toLowerCase();
            if (femaleKeywords.some(kw => nameLower.includes(kw))) {
                return voice;
            }
        }
    }
    
    for (const voice of voices) {
        if (voice.lang.startsWith('en')) {
            return voice;
        }
    }
    
    return voices[0] || null;
}

function speakText(text) {
    if (!synth || !ttsEnabled) return;
    
    // Cancel any current speech first
    synth.cancel();
    
    const cleanText = stripMarkdown(text);
    if (!cleanText) return;
    
    currentUtterance = new SpeechSynthesisUtterance(cleanText);
    
    const voice = getPreferredVoice();
    if (voice) {
        currentUtterance.voice = voice;
        currentUtterance.lang = voice.lang;
    }
    
    currentUtterance.rate = 1.0;
    currentUtterance.pitch = 1.1;
    currentUtterance.volume = 1.0;
    
    currentUtterance.onstart = function() {
        isSpeaking = true;
    };
    
    currentUtterance.onend = function() {
        isSpeaking = false;
    };
    
    currentUtterance.onerror = function(event) {
        console.error('TTS error:', event.error);
        isSpeaking = false;
    };
    
    synth.speak(currentUtterance);
}

function stopSpeaking() {
    if (synth) {
        synth.cancel();
    }
    isSpeaking = false;
}

function enableTTS() {
    ttsEnabled = true;
    $('#ttsBtn').addClass('speaking');
    $('#ttsBtn').attr('title', {{ _("Stop reading") | tojson }});
    // Speak the last message when enabled
    speakText(lastEriMessage);
}

function disableTTS() {
    ttsEnabled = false;
    stopSpeaking();
    $('#ttsBtn').removeClass('speaking');
    $('#ttsBtn').attr('title', {{ _("Read aloud") | tojson }});
}

function toggleTTS() {
    if (ttsEnabled) {
        disableTTS();
    } else {
        enableTTS();
    }
}

// Initialize TTS
initTTS();

// Load voices
if (synth) {
    synth.onvoiceschanged = function() {};
    // Force load voices on some browsers
    synth.getVoices();
}

// TTS button click handler
$('#ttsBtn').on('click', toggleTTS);


$('#sendBtn').on('click', sendMessage);
$('#userInput').on('keypress', function(e) {
    if (e.which === 13) sendMessage();
});

$('#promptDropdown').on('change', function () {
    const selected = $(this).val();
    if (selected) {
        $('#userInput').val(selected);
        $(this).val('');
    }
});

// Fetch prompts remaining on page load
$(document).ready(function() {
    fetchPromptsRemaining();
    initSpeechRecognition();
    $('#micBtn').on('click', toggleRecording);
});
// Help Sidebar functionality
$(document).ready(function() {
    // Toggle sidebar
    $('#helpToggle').on('click', function() {
        $('#helpSidebar').addClass('open');
        $('#helpToggle').addClass('hidden');
    });
    
    $('#closeHelp').on('click', function() {
        $('#helpSidebar').removeClass('open');
        // Delay showing the button until sidebar is closed
        setTimeout(function() {
            $('#helpToggle').removeClass('hidden');
        }, 300);
    });
    
    // Close sidebar when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#helpSidebar, #helpToggle').length) {
            if ($('#helpSidebar').hasClass('open')) {
                $('#helpSidebar').removeClass('open');
                setTimeout(function() {
                    $('#helpToggle').removeClass('hidden');
                }, 300);
            }
        }
    });
    
    // Handle collapsible sections with smooth animation
    $('.collapsible-header').on('click', function() {
        const isExpanded = $(this).attr('aria-expanded') === 'true';
        const content = $(this).next('.collapsible-content');
        const innerContent = content.find('.collapsible-content-inner');
        
        if (isExpanded) {
            // Closing
            $(this).attr('aria-expanded', 'false');
            content.css('height', content[0].scrollHeight + 'px');
            
            // Force reflow
            content[0].offsetHeight;
            
            // Animate to closed
            content.css('height', '0');
        } else {
            // Opening
            $(this).attr('aria-expanded', 'true');
            
            // Get the height we need to animate to
            content.css('height', 'auto');
            const targetHeight = content[0].scrollHeight;
            
            // Start from 0
            content.css('height', '0');
            
            // Force reflow
            content[0].offsetHeight;
            
            // Animate to target height
            content.css('height', targetHeight + 'px');
            
            // After animation, set to auto for responsive behavior
            setTimeout(function() {
                if ($(this).attr('aria-expanded') === 'true') {
                    content.css('height', 'auto');
                }
            }.bind(this), 300);
        }
    });
    
    // Prevent sidebar close when clicking inside it
    $('#helpSidebar').on('click', function(e) {
        e.stopPropagation();
    });
});
</script>
<!-- Help Sidebar -->
<div id="helpToggle" class="help-toggle" title="{{ _("Help & Instructions") }}">
    <i class="bi bi-question-circle-fill"></i>
</div>

<div id="helpSidebar" class="help-sidebar">
    <div class="help-header">
        <h5>{{ _("Help & Instructions") }}</h5>
        <button id="closeHelp" class="close-help" aria-label="Close">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    
    <div class="help-content">
        <div class="help-section">
            <div class="section-header">{{ _("Eri's Capabilities") }}</div>
            
            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span><i class="bi bi-camera-video me-2"></i>{{ _("Stream Stats & Schedules") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Ask Eri about streaming habits (monthly hours, averages, longest streams) or check real-time schedules to see who is live, upcoming, or recently finished streaming.") }}</p>
                    </div>
                </div>
            </div>

            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span><i class="bi bi-chat-text me-2"></i>{{ _("Chat & Community") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Analyze chat language makeup (EN/JP/KR/RU), engagement rates, and membership trends. Eri can also determine fanbase overlap by finding common users between different channels.") }}</p>
                    </div>
                </div>
            </div>

            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span><i class="bi bi-stars me-2"></i>{{ _("Content & Highlights") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Find AI-summarized highlights, search for specific moments (e.g., 'funny moments from Marine'), or locate the 'funniest' timestamp in a stream based on chat reactions.") }}</p>
                    </div>
                </div>
            </div>

            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span><i class="bi bi-bag-heart me-2"></i>{{ _("Channel & Merch") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Get channel metrics like subscriber counts and total views. Eri can also search the official Hololive Shop for merchandise (English or Japanese).") }}</p>
                    </div>
                </div>
            </div>
            
            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span><i class="bi bi-person-circle me-2"></i>{{ _("Personal Statistics") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Provide your YouTube Channel ID (starts with 'UC...') to see your own chat frequency, percentiles, and get channel recommendations based on your history.") }}</p>
                    </div>
                </div>
            </div>

            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span><i class="bi bi-window-sidebar me-2"></i>{{ _("Page Context") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Eri has a widget on most dataset pages and can answer questions about the specific data you are viewing. However, she cannot 'see' the visual UI or charts exactly as you do.") }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="help-section">
            <div class="section-header">{{ _("Eri's Limitations") }}</div>
            
            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span>{{ _("Data Scope") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Eri only has data for Hololive and select Indies. She does NOT have data for other agencies (e.g., Nijisanji) or Holostars.") }}</p>
                        <p class="mt-2">{{ _("Chat stats are updated monthly. Real-time data is available for schedules and merch only. No SuperChat or membership stream data.") }}</p>
                    </div>
                </div>
            </div>
            
            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span>{{ _("Accuracy & Complexity") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("Eri is an AI and may occasionally provide inaccurate information or hallucinate data.") }}</p>
                        <p class="mt-2">{{ _("She is limited to 3 data requests per prompt - please break down complex questions (e.g., comparing 5 different months).") }}</p>
                    </div>
                </div>
            </div>

            <div class="collapsible-item">
                <button class="collapsible-header" aria-expanded="false">
                    <span>{{ _("Daily Query Limits") }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <div class="collapsible-content-inner">
                        <p>{{ _("You have a limited number of queries per day, indicated by the counter next to the chat bubble icon. This quota resets daily at midnight UTC.") }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>